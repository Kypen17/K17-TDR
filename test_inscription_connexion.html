<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inscription & Connexion</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: Arial, sans-serif;
}

body {
    background: #f5f7fb;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    padding: 20px;
}

.card {
    width: 360px;
    background: #fff;
    padding: 35px;
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    animation: fadeIn 0.4s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.title {
    text-align: center;
    font-size: 28px;
    font-weight: 600;
    margin-bottom: 25px;
}

.toggle-buttons {
    display: flex;
    margin-bottom: 20px;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid #ddd;
}

.toggle-btn {
    flex: 1;
    padding: 12px;
    background: #f8f9fa;
    border: none;
    cursor: pointer;
    font-size: 15px;
    transition: all 0.3s;
}

.toggle-btn.active {
    background: #007bff;
    color: white;
}

.form-section {
    display: none;
}

.form-section.active {
    display: block;
}

.input-group {
    margin-bottom: 15px;
    position: relative;
}

input {
    width: 100%;
    padding: 13px;
    border: 1px solid #d9d9d9;
    border-radius: 6px;
    font-size: 15px;
}

input:focus {
    border-color: #007bff;
    outline: none;
}

.error {
    font-size: 12px;
    color: red;
    margin-top: 5px;
    display: none;
}

.password-row i {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    cursor: pointer;
    font-size: 17px;
    color: #777;
}

#strength, #loginStrength {
    height: 6px;
    border-radius: 4px;
    margin-top: 8px;
    display: none;
}

button[type="submit"] {
    width: 100%;
    padding: 13px;
    margin-top: 5px;
    border: none;
    background: #007bff;
    color: #fff;
    border-radius: 6px;
    font-size: 16px;
    cursor: pointer;
}

button[type="submit"]:disabled {
    background: #a6c8ff;
    cursor: not-allowed;
}

.or-container {
    display: flex;
    align-items: center;
    margin: 18px 0;
}

.or-container hr {
    flex: 1;
    border: none;
    border-top: 1px solid #ddd;
}

.or-container span {
    padding: 0 10px;
    font-size: 14px;
    color: #666;
}

.google-btn {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #fff;
    cursor: pointer;
    font-size: 15px;
    transition: all 0.3s;
    margin-top: 10px;
}

.google-btn:hover {
    background: #f8f9fa;
    border-color: #007bff;
}

.google-btn img {
    width: 20px;
    margin-right: 10px;
}

.user-info {
    text-align: center;
    display: none;
}

.user-info.active {
    display: block;
}

.user-info h3 {
    margin-bottom: 20px;
    color: #333;
}

.user-actions {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 20px;
}

.btn-home {
    background: #28a745;
    color: white;
    padding: 12px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
}

.btn-logout {
    background: #dc3545;
    color: white;
    padding: 12px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
}

.loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #007bff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 10px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.message {
    padding: 10px;
    border-radius: 6px;
    margin-top: 15px;
    display: none;
    text-align: center;
}

.success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.error-message {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}
</style>
</head>
<body>

<div class="card">
    <!-- Titre dynamique -->
    <div class="title" id="formTitle">S'inscrire</div>
    
    <!-- Boutons de toggle -->
    <div class="toggle-buttons">
        <button class="toggle-btn active" onclick="showSignup()">S'inscrire</button>
        <button class="toggle-btn" onclick="showLogin()">Se connecter</button>
    </div>
    
    <!-- Section d'inscription -->
    <div class="form-section active" id="signupSection">
        <form id="signupForm">
            <div class="input-group">
                <input type="text" id="name" placeholder="Nom">
                <div class="error" id="nameError">Le nom est requis (min. 2 caract√®res)</div>
            </div>

            <div class="input-group">
                <input type="email" id="signupEmail" placeholder="Email">
                <div class="error" id="emailError">Email invalide</div>
            </div>

            <div class="input-group password-row">
                <input type="password" id="signupPassword" placeholder="Mot de passe">
                <i onclick="togglePassword('signupPassword')">üëÅ</i>
                <div id="strength"></div>
                <div class="error" id="pwdError">Le mot de passe doit contenir au moins 6 caract√®res</div>
            </div>

            <button type="submit" id="signupBtn">
                <span class="loading" style="display: none;"></span>
                <span>S'inscrire</span>
            </button>
        </form>
    </div>
    
    <!-- Section de connexion -->
    <div class="form-section" id="loginSection">
        <form id="loginForm">
            <div class="input-group">
                <input type="email" id="loginEmail" placeholder="Email">
                <div class="error" id="loginEmailError">Email invalide</div>
            </div>

            <div class="input-group password-row">
                <input type="password" id="loginPassword" placeholder="Mot de passe">
                <i onclick="togglePassword('loginPassword')">üëÅ</i>
                <div id="loginStrength"></div>
                <div class="error" id="loginPwdError">Le mot de passe est requis</div>
            </div>

            <button type="submit" id="loginBtn">
                <span class="loading" style="display: none;"></span>
                <span>Se connecter</span>
            </button>
        </form>
    </div>
    
    <!-- Messages -->
    <div class="message" id="successMessage"></div>
    <div class="message error-message" id="errorMessage"></div>
    
    <!-- S√©parateur pour Google -->
    <div class="or-container">
        <hr>
        <span>ou</span>
        <hr>
    </div>
    
    <!-- Bouton Google -->
    <button class="google-btn" onclick="signInWithGoogle()">
        <img src="goo.png">
        Continuer avec Google
    </button>
    
    <!-- Section utilisateur connect√© -->
    <div class="user-info" id="userInfo">
        <h3>Bienvenue !</h3>
        <div class="user-actions">
            <button class="btn-home" onclick="redirectToHome()">Aller √† l'accueil</button>
            <button class="btn-logout" onclick="signOut()">D√©connexion</button>
        </div>
    </div>
</div>

<script>
// Configuration Supabase
const supabaseUrl = 'https://zgbvomvdfjsceemfnlrk.supabase.co'
const supabaseKey = 'sb_publishable_plH-pImHRoYCMcIVt2koEg_ci-Izu02'
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey)

// √âl√©ments DOM
let currentUser = null
let isLoading = false

// Initialisation
document.addEventListener('DOMContentLoaded', async () => {
    await checkAuthStatus()
    setupFormValidation()
})

// V√©rifier l'√©tat d'authentification
async function checkAuthStatus() {
    try {
        const { data: { user } } = await supabase.auth.getUser()
        if (user) {
            showUserInfo(user)
        } else {
            showAuthForms()
        }
    } catch (error) {
        console.error('Erreur de v√©rification:', error)
        showAuthForms()
    }
}

// Afficher les formulaires d'authentification
function showAuthForms() {
    document.getElementById('signupSection').classList.remove('active')
    document.getElementById('loginSection').classList.remove('active')
    document.getElementById('userInfo').classList.remove('active')
    
    // Par d√©faut, montrer l'inscription
    showSignup()
}

// Afficher les informations utilisateur
function showUserInfo(user) {
    currentUser = user
    document.getElementById('userEmail').textContent = user.email
    document.getElementById('signupSection').classList.remove('active')
    document.getElementById('loginSection').classList.remove('active')
    document.getElementById('userInfo').classList.add('active')
    document.getElementById('formTitle').textContent = 'Mon Compte'
}

// Toggle entre inscription et connexion
function showSignup() {
    document.getElementById('signupSection').classList.add('active')
    document.getElementById('loginSection').classList.remove('active')
    document.querySelectorAll('.toggle-btn')[0].classList.add('active')
    document.querySelectorAll('.toggle-btn')[1].classList.remove('active')
    document.getElementById('formTitle').textContent = 'S\'inscrire'
    clearMessages()
}

function showLogin() {
    document.getElementById('signupSection').classList.remove('active')
    document.getElementById('loginSection').classList.add('active')
    document.querySelectorAll('.toggle-btn')[0].classList.remove('active')
    document.querySelectorAll('.toggle-btn')[1].classList.add('active')
    document.getElementById('formTitle').textContent = 'Se connecter'
    clearMessages()
}

// Toggle visibilit√© mot de passe
function togglePassword(fieldId) {
    const field = document.getElementById(fieldId)
    field.type = field.type === 'password' ? 'text' : 'password'
}

// Configuration validation formulaire
function setupFormValidation() {
    // Validation inscription
    const signupEmail = document.getElementById('signupEmail')
    const signupPassword = document.getElementById('signupPassword')
    const nameField = document.getElementById('name')
    
    signupEmail.addEventListener('input', validateSignupForm)
    signupPassword.addEventListener('input', function() {
        validateSignupForm()
        checkPasswordStrength('signupPassword', 'strength')
    })
    nameField.addEventListener('input', validateSignupForm)
    
    // Validation connexion
    const loginEmail = document.getElementById('loginEmail')
    const loginPassword = document.getElementById('loginPassword')
    
    loginEmail.addEventListener('input', validateLoginForm)
    loginPassword.addEventListener('input', function() {
        validateLoginForm()
        checkPasswordStrength('loginPassword', 'loginStrength')
    })
    
    // Soumission formulaires
    document.getElementById('signupForm').addEventListener('submit', handleSignup)
    document.getElementById('loginForm').addEventListener('submit', handleLogin)
}

// Validation formulaire d'inscription
function validateSignupForm() {
    const name = document.getElementById('name').value.trim()
    const email = document.getElementById('signupEmail').value
    const password = document.getElementById('signupPassword').value
    
    let isValid = true
    
    // Validation nom
    if (name.length < 2) {
        document.getElementById('nameError').style.display = 'block'
        isValid = false
    } else {
        document.getElementById('nameError').style.display = 'none'
    }
    
    // Validation email
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/
    if (!emailRegex.test(email)) {
        document.getElementById('emailError').style.display = 'block'
        isValid = false
    } else {
        document.getElementById('emailError').style.display = 'none'
    }
    
    // Validation mot de passe
    if (password.length < 6) {
        document.getElementById('pwdError').style.display = 'block'
        isValid = false
    } else {
        document.getElementById('pwdError').style.display = 'none'
    }
    
    document.getElementById('signupBtn').disabled = !isValid
    return isValid
}

// Validation formulaire de connexion
function validateLoginForm() {
    const email = document.getElementById('loginEmail').value
    const password = document.getElementById('loginPassword').value
    
    let isValid = true
    
    // Validation email
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/
    if (!emailRegex.test(email)) {
        document.getElementById('loginEmailError').style.display = 'block'
        isValid = false
    } else {
        document.getElementById('loginEmailError').style.display = 'none'
    }
    
    // Validation mot de passe
    if (password.length === 0) {
        document.getElementById('loginPwdError').style.display = 'block'
        isValid = false
    } else {
        document.getElementById('loginPwdError').style.display = 'none'
    }
    
    document.getElementById('loginBtn').disabled = !isValid
    return isValid
}

// V√©rifier la force du mot de passe
function checkPasswordStrength(passwordFieldId, strengthBarId) {
    const bar = document.getElementById(strengthBarId)
    const password = document.getElementById(passwordFieldId).value
    
    if (password.length === 0) {
        bar.style.display = 'none'
        return
    }
    
    bar.style.display = 'block'
    
    let strength = 0
    if (password.length >= 6) strength++
    if (/[A-Z]/.test(password)) strength++
    if (/[0-9]/.test(password)) strength++
    if (/[^A-Za-z0-9]/.test(password)) strength++
    
    const colors = ['#ff4444', '#ffbb33', '#00C851', '#007E33']
    bar.style.background = colors[strength - 1] || colors[0]
}

// G√©rer l'inscription
async function handleSignup(e) {
    e.preventDefault()
    
    if (!validateSignupForm() || isLoading) return
    
    const email = document.getElementById('signupEmail').value
    const password = document.getElementById('signupPassword').value
    const name = document.getElementById('name').value.trim()
    
    setLoading('signupBtn', true)
    clearMessages()
    
    try {
        const { data, error } = await supabase.auth.signUp({
            email: email,
            password: password,
            options: {
                data: {
                    full_name: name
                }
            }
        })
        
        if (error) throw error
        
        showSuccess('Compte cr√©√© avec succ√®s ! Redirection vers l\'accueil...')
        
        // Stocker le nom dans une table suppl√©mentaire (optionnel)
        if (data.user) {
            await createUserProfile(data.user.id, name, email)
        }
        
        // Redirection apr√®s 2 secondes
        setTimeout(() => {
            redirectToHome()
        }, 2000)
        
    } catch (error) {
        showError('Erreur d\'inscription: ' + error.message)
    } finally {
        setLoading('signupBtn', false)
    }
}

// G√©rer la connexion
async function handleLogin(e) {
    e.preventDefault()
    
    if (!validateLoginForm() || isLoading) return
    
    const email = document.getElementById('loginEmail').value
    const password = document.getElementById('loginPassword').value
    
    setLoading('loginBtn', true)
    clearMessages()
    
    try {
        const { data, error } = await supabase.auth.signInWithPassword({
            email: email,
            password: password
        })
        
        if (error) throw error
        
        showSuccess('Connexion r√©ussie ! Redirection vers l\'accueil...')
        
        // Redirection apr√®s 1.5 secondes
        setTimeout(() => {
            redirectToHome()
        }, 1500)
        
    } catch (error) {
        showError('Erreur de connexion: ' + error.message)
    } finally {
        setLoading('loginBtn', false)
    }
}

// Connexion avec Google
async function signInWithGoogle() {
    try {
        const redirectTo = window.location.origin + '/index.html'
        
        const { error } = await supabase.auth.signInWithOAuth({
            provider: 'google',
            options: {
                redirectTo: redirectTo
            }
        })
        
        if (error) throw error
    } catch (error) {
        showError('Erreur Google: ' + error.message)
    }
}

// D√©connexion
async function signOut() {
    try {
        await supabase.auth.signOut()
        currentUser = null
        showAuthForms()
        clearMessages()
    } catch (error) {
        showError('Erreur de d√©connexion: ' + error.message)
    }
}

// Redirection vers l'accueil
function redirectToHome() {
    window.location.href = 'index.html'
}

// Cr√©er un profil utilisateur (optionnel)
async function createUserProfile(userId, name, email) {
    try {
        const { error } = await supabase
            .from('profiles')
            .upsert({
                id: userId,
                full_name: name,
                email: email,
                updated_at: new Date()
            })
        
        if (error) throw error
    } catch (error) {
        console.error('Erreur cr√©ation profil:', error)
    }
}

// Gestion du chargement
function setLoading(buttonId, loading) {
    isLoading = loading
    const button = document.getElementById(buttonId)
    const loadingIcon = button.querySelector('.loading')
    const buttonText = button.querySelector('span:last-child')
    
    if (loading) {
        loadingIcon.style.display = 'inline-block'
        buttonText.textContent = 'Chargement...'
        button.disabled = true
    } else {
        loadingIcon.style.display = 'none'
        buttonText.textContent = buttonId === 'signupBtn' ? 'S\'inscrire' : 'Se connecter'
        button.disabled = false
    }
}

// Afficher les messages
function showSuccess(message) {
    const successEl = document.getElementById('successMessage')
    successEl.textContent = message
    successEl.className = 'message success'
    successEl.style.display = 'block'
    
    document.getElementById('errorMessage').style.display = 'none'
}

function showError(message) {
    const errorEl = document.getElementById('errorMessage')
    errorEl.textContent = message
    errorEl.style.display = 'block'
    
    document.getElementById('successMessage').style.display = 'none'
}

function clearMessages() {
    document.getElementById('successMessage').style.display = 'none'
    document.getElementById('errorMessage').style.display = 'none'
}

// √âcouter les changements d'√©tat d'authentification
supabase.auth.onAuthStateChange((event, session) => {
    console.log('Auth event:', event)
    
    if (event === 'SIGNED_IN' && session?.user) {
        showUserInfo(session.user)
    } else if (event === 'SIGNED_OUT') {
        showAuthForms()
    }
})
</script>

</body>
</html>